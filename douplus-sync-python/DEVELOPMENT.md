# DOU+ è®¢å•ç®¡ç†ç³»ç»Ÿ - PythonåŒæ­¥æœåŠ¡å¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
- [å®‰è£…éƒ¨ç½²](#å®‰è£…éƒ¨ç½²)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [è¿ç»´ç®¡ç†](#è¿ç»´ç®¡ç†)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®æ¦‚è¿°

### ç³»ç»Ÿç®€ä»‹

DOU+ è®¢å•ç®¡ç†ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº**Java + Pythonæ··åˆæ¶æ„**çš„è®¢å•åŒæ­¥ä¸æ•°æ®åˆ†æå¹³å°ã€‚

**æ¶æ„åˆ†å±‚**:
- **å‰ç«¯**: Vue 3 + TypeScript + Element Plus
- **æŸ¥è¯¢æœåŠ¡**: Java Spring Boot 3.2 (æˆæƒã€è®¢å•åˆ—è¡¨æŸ¥è¯¢)
- **åŒæ­¥æœåŠ¡**: Python + Celery (è®¢å•åŒæ­¥ã€æ•ˆæœæ•°æ®åŒæ­¥ã€è§†é¢‘èšåˆ)
- **æ•°æ®åº“**: MySQL 5.7
- **æ¶ˆæ¯é˜Ÿåˆ—**: Redis

### æŠ€æœ¯å†³ç­–

#### ä¸ºä»€ä¹ˆä½¿ç”¨Pythoné‡æ„åŒæ­¥æœåŠ¡?

| å¯¹æ¯”é¡¹ | Javaæ–¹æ¡ˆ | Pythonæ–¹æ¡ˆ | é€‰æ‹©ç†ç”± |
|--------|---------|-----------|---------|
| å¼€å‘æ•ˆç‡ | 2å‘¨ | 1å‘¨ | âœ… å¼€å‘å¿« |
| å›¢é˜Ÿç†Ÿæ‚‰åº¦ | ä½ | é«˜ | âœ… æ˜“ç»´æŠ¤ |
| ä»£ç é‡ | ~1000è¡Œ | ~600è¡Œ | âœ… ä»£ç ç®€æ´ |
| éƒ¨ç½²å¤æ‚åº¦ | ä¸­ | ä½ | âœ… éƒ¨ç½²ç®€å• |
| èµ„æºå ç”¨ | ä¸­(JVM) | ä½ | âœ… çœèµ„æº |
| ä»»åŠ¡è°ƒåº¦ | @Scheduled | Celery | âœ… æ›´å¼ºå¤§ |

**æœ€ç»ˆå†³ç­–**: é‡‡ç”¨**Java + Pythonæ··åˆæ¶æ„**,Javaä¿ç•™æˆæƒå’ŒæŸ¥è¯¢,Pythonè´Ÿè´£æ•°æ®åŒæ­¥ã€‚

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å‰ç«¯ (Vue 3)                     â”‚
â”‚  - è®¢å•åˆ—è¡¨å±•ç¤º                          â”‚
â”‚  - è´¦å·ç®¡ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTPS
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Java Spring Boot (æŸ¥è¯¢å±‚)              â”‚
â”‚  - OAuthæˆæƒæ¨¡å—                         â”‚
â”‚  - è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£                       â”‚
â”‚  - è´¦å·ç®¡ç†æ¥å£                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ è¯»å–
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MySQL æ•°æ®åº“                    â”‚
â”‚  - douyin_account (è´¦å·è¡¨)               â”‚
â”‚  - douplus_order (è®¢å•åŸºç¡€è¡¨)            â”‚
â”‚  - douplus_order_stats (æ•ˆæœæ˜ç»†è¡¨)      â”‚
â”‚  - douplus_video_stats_agg (é¢„èšåˆè¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘
                  â”‚ å†™å…¥
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Python Celery (åŒæ­¥å±‚)                 â”‚
â”‚  - è®¢å•åŒæ­¥Worker                        â”‚
â”‚  - æ•ˆæœæ•°æ®åŒæ­¥Worker                    â”‚
â”‚  - è§†é¢‘èšåˆWorker                        â”‚
â”‚  - å®šæ—¶è°ƒåº¦(Celery Beat)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æŠ–éŸ³DOU+ API v3.0                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‰å±‚æ¶æ„è®¾è®¡

#### 1. åŒæ­¥å±‚ (Sync Layer)
**èŒè´£**: åªè´Ÿè´£ä»æŠ–éŸ³APIè·å–åŸå§‹æ•°æ®å¹¶å­˜å‚¨,ä¸åšä»»ä½•è®¡ç®—

- **è®¢å•åŒæ­¥**: `order_sync.py`
  - å…¨é‡åŒæ­¥: æœ€è¿‘90å¤©æ‰€æœ‰è®¢å•
  - å¢é‡åŒæ­¥: æœ€è¿‘7å¤©æœ‰æ›´æ–°çš„è®¢å•
  - é¢‘ç‡: æ¯5åˆ†é’Ÿ

- **æ•ˆæœæ•°æ®åŒæ­¥**: `stats_sync.py`
  - åŒæ­¥è®¢å•æ•ˆæœæ•°æ®(æ’­æ”¾ã€ç‚¹èµã€è½¬å‘ç­‰)
  - æŒ‰æ—¶é—´çª—å£å­˜å‚¨(5åˆ†é’Ÿç²’åº¦)
  - é¢‘ç‡: æ¯5åˆ†é’Ÿ(å»¶è¿Ÿ1åˆ†é’Ÿ)

#### 2. ç»Ÿè®¡å±‚ (Aggregation Layer)
**èŒè´£**: å°†åŸå§‹æ•°æ®æŒ‰è§†é¢‘ç»´åº¦é¢„å…ˆèšåˆè®¡ç®—

- **è§†é¢‘èšåˆ**: `video_agg.py` (å¾…å®ç°)
  - æŒ‰item_idèšåˆå¤šè®¢å•æ•°æ®
  - é¢„è®¡ç®—ç™¾æ’­æ”¾é‡ã€ç‚¹èµæ¯”ã€è½¬å‘æ¯”ç­‰æŒ‡æ ‡
  - é¢‘ç‡: æ¯5åˆ†é’Ÿ(å»¶è¿Ÿ2åˆ†é’Ÿ)

#### 3. æŸ¥è¯¢å±‚ (Query Layer)
**èŒè´£**: æä¾›é«˜æ€§èƒ½æŸ¥è¯¢æ¥å£,ä¸åšå®æ—¶è®¡ç®—

- **è®¢å•åˆ—è¡¨**: âš ï¸ **é‡è¦**: æŸ¥è¯¢`douplus_order_stats`è¡¨(è®¢å•ç»´åº¦),å“åº”æ—¶é—´ < 200ms
- **è§†é¢‘æ’è¡Œ**: æŸ¥è¯¢`douplus_video_stats_agg`è¡¨(è§†é¢‘ç»´åº¦)
- **è®¢å•è¯¦æƒ…**: æŸ¥è¯¢åŸºç¡€è¡¨ + æ•ˆæœæ˜ç»†è¡¨
- **è´¦å·ç®¡ç†**: è´¦å·CRUDæ“ä½œ

**æ•°æ®è¡¨ä½¿ç”¨è§„èŒƒ**:

| æŸ¥è¯¢åœºæ™¯ | ä½¿ç”¨è¡¨ | ç»´åº¦ | è¯´æ˜ |
|---------|-------|------|------|
| è®¢å•åˆ—è¡¨ | `douplus_order_stats` | order_id | æ¯ä¸ªè®¢å•ç‹¬ç«‹æ•°æ® |
| è§†é¢‘æ’è¡Œ | `douplus_video_stats_agg` | item_id | è§†é¢‘æ±‡æ€»æ•°æ® |
| è´¦å·ç»Ÿè®¡ | `douplus_video_stats_agg` | account_id | è´¦å·æ±‡æ€»æ•°æ® |

âš ï¸ **å¸¸è§é”™è¯¯**: è®¢å•åˆ—è¡¨æ¥å£ç¦æ­¢ä½¿ç”¨è§†é¢‘é¢„èšåˆè¡¨,ä¼šå¯¼è‡´åŒä¸€è§†é¢‘çš„å¤šä¸ªè®¢å•æ˜¾ç¤ºç›¸åŒæ•°æ®

---

## æŠ€æœ¯æ ˆ

### PythonåŒæ­¥æœåŠ¡

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|------|
| æ ¸å¿ƒæ¡†æ¶ | Celery | 5.3.4 | åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ— |
| æ¶ˆæ¯é˜Ÿåˆ— | Redis | 5.0.1 | Celery Broker |
| æ•°æ®åº“ORM | SQLAlchemy | 2.0.23 | ORMæ¡†æ¶ |
| MySQLé©±åŠ¨ | PyMySQL | 1.1.0 | MySQLè¿æ¥å™¨ |
| HTTPå®¢æˆ·ç«¯ | httpx | 0.25.2 | å¼‚æ­¥HTTP |
| æ•°æ®éªŒè¯ | Pydantic | 2.5.2 | é…ç½®ç®¡ç† |
| æ—¥å¿— | loguru | 0.7.2 | æ—¥å¿—åº“ |

### JavaæŸ¥è¯¢æœåŠ¡

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| æ¡†æ¶ | Spring Boot | 3.2 |
| ORM | MyBatis Plus | 3.5.5 |
| æ•°æ®åº“ | MySQL | 5.7 |
| JDK | OpenJDK | 17 |

---

## é¡¹ç›®ç»“æ„

```
/opt/douplus/douplus-sync-python/
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–åˆ—è¡¨
â”œâ”€â”€ setup.sh                      # ç¯å¢ƒå‡†å¤‡è„šæœ¬ â­
â”œâ”€â”€ manage.sh                     # æœåŠ¡ç®¡ç†è„šæœ¬ â­
â”œâ”€â”€ test.py                       # ä»£ç æµ‹è¯•è„šæœ¬ â­
â”œâ”€â”€ api_server.py                 # Flask APIæœåŠ¡å™¨å…¥å£ (148è¡Œ) â­
â”œâ”€â”€ api_server.py.backup          # æ—§ç‰ˆå•æ–‡ä»¶API (1581è¡Œ,å·²åºŸå¼ƒ)
â”œâ”€â”€ celery_app.py                 # Celeryåº”ç”¨é…ç½®
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                 # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ models.py                 # SQLAlchemyæ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ douyin_client.py          # æŠ–éŸ³APIå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ api/                      # APIæ¨¡å— (ä¸‰å±‚è§£è€¦æ¶æ„) â­â­â­
â”‚   â”‚   â”œâ”€â”€ __init__.py           # è“å›¾æ³¨å†Œä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ common.py             # è®¤è¯è£…é¥°å™¨å’Œé€šç”¨å·¥å…·
â”‚   â”‚   â”œâ”€â”€ sync_api.py           # åŒæ­¥å±‚API - è®¢å•é‡‡é›†
â”‚   â”‚   â”œâ”€â”€ stats_api.py          # ç»Ÿè®¡å±‚API - æ•°æ®èšåˆ
â”‚   â”‚   â”œâ”€â”€ query_api.py          # æŸ¥è¯¢å±‚API - å‰ç«¯æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ account_api.py        # è´¦å·ç®¡ç†API - CRUDæ“ä½œ
â”‚   â”œâ”€â”€ tasks/                    # Celeryä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ order_sync.py         # è®¢å•åŒæ­¥ä»»åŠ¡
â”‚   â”‚   â””â”€â”€ stats_sync.py         # æ•ˆæœæ•°æ®åŒæ­¥ä»»åŠ¡
â”‚   â””â”€â”€ utils/                    # å·¥å…·ç±»
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ time_window.py        # æ—¶é—´çª—å£å·¥å…·
â”‚       â”œâ”€â”€ crypto.py             # åŠ å¯†è§£å¯†å·¥å…·
â”‚       â””â”€â”€ auth.py               # JWTè®¤è¯å·¥å…·
â”œâ”€â”€ logs/                         # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ api.log                   # APIæœåŠ¡æ—¥å¿—
â”‚   â”œâ”€â”€ worker.log                # Workeræ—¥å¿—
â”‚   â””â”€â”€ beat.log                  # Beatæ—¥å¿—
â””â”€â”€ tests/                        # å•å…ƒæµ‹è¯•
```

### APIæ¨¡å—åŒ–æ¶æ„è¯´æ˜ â­

ä»v2.0.0å¼€å§‹,APIæœåŠ¡é‡‡ç”¨**ä¸‰å±‚è§£è€¦æ¶æ„**,å°†åŸ1581è¡Œçš„`api_server.py`æ‹†åˆ†ä¸ºå¤šä¸ªèŒè´£æ¸…æ™°çš„æ¨¡å—:

#### ğŸ“Š é‡æ„å‰åå¯¹æ¯”

| é¡¹ç›® | v1.x (å•æ–‡ä»¶) | v2.0 (æ¨¡å—åŒ–) | æ”¹å–„ |
|------|--------------|--------------|------|
| api_server.py | 1,581è¡Œ | 148è¡Œ | **-90.6%** |
| ä»£ç ç»„ç»‡ | å•æ–‡ä»¶æ··åˆ | æ¨¡å—åŒ–åˆ†å±‚ | âœ… |
| å¯ç»´æŠ¤æ€§ | ä½ | é«˜ | âœ… |
| æµ‹è¯•éš¾åº¦ | é«˜ | ä½ | âœ… |

#### ğŸ—ï¸ æ¨¡å—èŒè´£åˆ’åˆ†

**1. app/api/sync_api.py (åŒæ­¥å±‚)**
- è§¦å‘è®¢å•åŒæ­¥(å…¨é‡/å¢é‡)
- æŸ¥è¯¢åŒæ­¥çŠ¶æ€
- DOU+å¹³å°å›è°ƒæ¥æ”¶
- **åŸåˆ™**: åªè´Ÿè´£ä»»åŠ¡æäº¤,ä¸åšä¸šåŠ¡è®¡ç®—

**2. app/api/stats_api.py (ç»Ÿè®¡å±‚)**  
- è´¦å·ç»´åº¦ç»Ÿè®¡(å•ä¸ª/å…¨éƒ¨)
- è§†é¢‘ç»´åº¦ç»Ÿè®¡
- æ”¯æŒå¤šæ—¶é—´å‘¨æœŸ(today/7d/30d/all)
- **åŸåˆ™**: ä»é¢„èšåˆè¡¨æŸ¥è¯¢,æ— JOIN

**3. app/api/query_api.py (æŸ¥è¯¢å±‚)**
- è®¢å•åˆ—è¡¨åˆ†é¡µæŸ¥è¯¢
- è§†é¢‘ç»Ÿè®¡åˆ—è¡¨æŸ¥è¯¢
- æ”¯æŒç­›é€‰ã€æ’åºã€åˆ†é¡µ
- **åŸåˆ™**: å“åº”æ—¶é—´<200ms
- **æ•°æ®æºè§„èŒƒ**:
  - è®¢å•åˆ—è¡¨: ä½¿ç”¨ `douplus_order_stats` (è®¢å•ç»´åº¦)
  - è§†é¢‘æ’è¡Œ: ä½¿ç”¨ `douplus_video_stats_agg` (è§†é¢‘ç»´åº¦)

**4. app/api/account_api.py (è´¦å·ç®¡ç†)**
- è´¦å·åˆ—è¡¨/è¯¦æƒ…æŸ¥è¯¢
- çº¯CRUDæ“ä½œ
- **åŸåˆ™**: æ— ä¸šåŠ¡é€»è¾‘è€¦åˆ

**5. app/api/common.py (é€šç”¨å·¥å…·)**
- JWTè®¤è¯è£…é¥°å™¨ `@require_auth`
- ç»Ÿä¸€å“åº”æ ¼å¼ `success_response()` / `error_response()`
- åˆ†é¡µå“åº” `paginated_response()`

#### ğŸ¯ æ¶æ„ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**: ä¿®æ”¹åŒæ­¥é€»è¾‘ä¸å½±å“æŸ¥è¯¢æ¥å£
2. **ç‹¬ç«‹æµ‹è¯•**: å¯å•ç‹¬æµ‹è¯•æ¯ä¸€å±‚
3. **æ˜“äºæ‰©å±•**: æ–°å¢æ¥å£åªéœ€åœ¨å¯¹åº”å±‚æ·»åŠ 
4. **é™ä½é£é™©**: é¿å…"ç‰µä¸€å‘åŠ¨å…¨èº«"
5. **ä»£ç å¤ç”¨**: é€šç”¨å·¥å…·ç»Ÿä¸€ç®¡ç†

#### ğŸ“ å¼€å‘è§„èŒƒ

**æ–°å¢APIæ—¶,è¯·éµå¾ªä»¥ä¸‹åŸåˆ™:**

```python
# âœ… æ­£ç¡®: åœ¨å¯¹åº”å±‚æ·»åŠ æ¥å£
# app/api/query_api.py
@query_bp.route('/task/export', methods=['GET'])
@require_auth
def export_tasks():
    """å¯¼å‡ºè®¢å•åˆ—è¡¨"""
    # æŸ¥è¯¢å±‚èŒè´£: æ•°æ®å¯¼å‡º
    pass

# âŒ é”™è¯¯: åœ¨api_server.pyç›´æ¥æ·»åŠ 
# api_server.py
@app.route('/api/douplus/task/export')  # ä¸è¦è¿™æ ·åš!
def export_tasks():
    pass
```

**è·¯ç”±æ³¨å†Œè¯´æ˜:**

æ‰€æœ‰APIè“å›¾åœ¨`app/api/__init__.py`ä¸­ç»Ÿä¸€æ³¨å†Œ:

```python
# è“å›¾å‰ç¼€
sync_bp    -> /api/douplus/*    # åŒæ­¥å±‚
stats_bp   -> /api/douplus/*    # ç»Ÿè®¡å±‚  
query_bp   -> /api/douplus/*    # æŸ¥è¯¢å±‚
account_bp -> /api/*            # è´¦å·ç®¡ç†
```

---

## ç¯å¢ƒé…ç½®

### é…ç½®æ–‡ä»¶: `.env`

```env
# æ•°æ®åº“é…ç½®
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=douplus
DB_USER=douplus
DB_PASSWORD=Asd123000

# Redisé…ç½®
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_DB=0

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO
LOG_PATH=/opt/douplus/douplus-sync-python/logs

# åŒæ­¥é…ç½®
SYNC_INCREMENTAL_DAYS=7  # å¢é‡åŒæ­¥æŸ¥è¯¢æœ€è¿‘Nå¤©
SYNC_FULL_DAYS=90        # å…¨é‡åŒæ­¥æŸ¥è¯¢æœ€è¿‘Nå¤©
```

### æ•°æ®åº“è¡¨ç»“æ„

#### 1. douplus_order (è®¢å•åŸºç¡€è¡¨)
å­˜å‚¨è®¢å•åŸºç¡€ä¿¡æ¯,ä¸å«æ•ˆæœæ•°æ®

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | BIGINT | ä¸»é”® |
| order_id | VARCHAR(64) | è®¢å•ID(å”¯ä¸€) |
| item_id | VARCHAR(64) | è§†é¢‘ID |
| account_id | BIGINT | è´¦å·ID |
| status | VARCHAR(32) | è®¢å•çŠ¶æ€ |
| budget | DECIMAL(10,2) | é¢„ç®—(å…ƒ) |
| sync_version | BIGINT | åŒæ­¥ç‰ˆæœ¬å· |
| last_sync_time | DATETIME | æœ€ååŒæ­¥æ—¶é—´ |

#### 2. douplus_order_stats (æ•ˆæœæ•°æ®æ˜ç»†è¡¨)
æŒ‰æ—¶é—´ç»´åº¦å­˜å‚¨æ•ˆæœæ•°æ®,5åˆ†é’Ÿç²’åº¦

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | BIGINT | ä¸»é”® |
| order_id | VARCHAR(64) | è®¢å•ID |
| item_id | VARCHAR(64) | è§†é¢‘ID |
| stat_time | DATETIME | ç»Ÿè®¡æ—¶é—´(5åˆ†é’Ÿçª—å£) |
| stat_cost | DECIMAL(10,2) | æ¶ˆè€—(å…ƒ) |
| total_play | INT | æ’­æ”¾é‡ |
| custom_like | INT | ç‚¹èµæ•° |
| dy_share | INT | è½¬å‘æ•° |
| dp_target_convert_cnt | INT | è½¬åŒ–æ•° |
| custom_convert_cost | DECIMAL(10,2) | è½¬åŒ–æˆæœ¬(å…ƒ) |

å”¯ä¸€é”®: `(order_id, stat_time)`

#### 3. douplus_video_stats_agg (è§†é¢‘é¢„èšåˆè¡¨)
æŒ‰è§†é¢‘IDèšåˆå¤šè®¢å•æ•°æ®,å‰ç«¯ç›´æ¥æŸ¥è¯¢æ­¤è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | BIGINT | ä¸»é”® |
| item_id | VARCHAR(64) | è§†é¢‘ID |
| stat_time | DATETIME | ç»Ÿè®¡æ—¶é—´ |
| order_count | INT | è®¢å•æ•°é‡ |
| total_cost | DECIMAL(10,2) | æ€»æ¶ˆè€— |
| total_play | BIGINT | æ€»æ’­æ”¾é‡ |
| play_per_100_cost | DECIMAL(10,2) | ç™¾æ’­æ”¾é‡(é¢„è®¡ç®—) |
| like_rate | DECIMAL(10,4) | ç‚¹èµæ¯”(é¢„è®¡ç®—) |
| share_rate | DECIMAL(10,4) | è½¬å‘æ¯”(é¢„è®¡ç®—) |

å”¯ä¸€é”®: `(item_id, stat_time)`

---

## æ•°æ®æ¶æ„ä¸æŸ¥è¯¢è§„èŒƒ

### æ•°æ®è¡¨å±‚æ¬¡ç»“æ„

DOU+ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚æ•°æ®æ¶æ„,ä¸åŒæŸ¥è¯¢åœºæ™¯ä½¿ç”¨ä¸åŒçš„è¡¨:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åŸå§‹æ•°æ®å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ douplus_order                è®¢å•åŸºç¡€è¡¨ (order_idç»´åº¦)      â”‚
â”‚ douplus_order_stats          è®¢å•æ•ˆæœæ˜ç»†è¡¨ (order_idç»´åº¦)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ èšåˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é¢„èšåˆæ•°æ®å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ douplus_video_stats_agg      è§†é¢‘ç»´åº¦èšåˆè¡¨ (item_idç»´åº¦)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŸ¥è¯¢åœºæ™¯ä¸æ•°æ®è¡¨å¯¹ç…§

âš ï¸ **å…³é”®åŸåˆ™**: ä¸åŒæŸ¥è¯¢åœºæ™¯å¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ•°æ®è¡¨,å¦åˆ™ä¼šå¯¼è‡´æ•°æ®é”™è¯¯!

| æŸ¥è¯¢åœºæ™¯ | æ­£ç¡®çš„è¡¨ | ç»´åº¦ | é”™è¯¯ç¤ºä¾‹ | åæœ |
|---------|---------|------|---------|------|
| **è®¢å•åˆ—è¡¨** | `douplus_order_stats` | order_id | âŒ ä½¿ç”¨ `douplus_video_stats_agg` | åŒä¸€è§†é¢‘çš„å¤šä¸ªè®¢å•æ˜¾ç¤ºç›¸åŒæ•°æ® |
| **è§†é¢‘æ’è¡Œ** | `douplus_video_stats_agg` | item_id | âŒ ä½¿ç”¨ `douplus_order_stats` | åŒä¸€è§†é¢‘å¤šä¸ªè®¢å•æ•°æ®é‡å¤,æ’åæ··ä¹± |
| **è´¦å·ç»Ÿè®¡** | `douplus_video_stats_agg` | account_id | âŒ ä½¿ç”¨ `douplus_order_stats` | é‡å¤è®¡ç®—,æ•°æ®ä¸å‡†ç¡® |

### æ•°æ®è¡¨è¯¦ç»†è¯´æ˜

#### 1. douplus_order_stats (è®¢å•æ•ˆæœæ˜ç»†è¡¨)

**ç”¨é€”**: è®¢å•åˆ—è¡¨æŸ¥è¯¢,æ¯ä¸ªè®¢å•çš„ç‹¬ç«‹æ•ˆæœæ•°æ®

**ç»´åº¦**: `order_id` + `stat_time` (æ¯5åˆ†é’Ÿä¸€æ¡)

**å…¸å‹æŸ¥è¯¢** (è®¢å•åˆ—è¡¨æ¥å£):
```sql
-- æŸ¥è¯¢æ¯ä¸ªè®¢å•çš„æœ€æ–°æ•ˆæœæ•°æ®
SELECT 
    order_id, 
    stat_cost,           -- è®¢å•å®é™…æ¶ˆè€—
    total_play,          -- è®¢å•æ’­æ”¾é‡
    custom_like,         -- è®¢å•ç‚¹èµæ•°
    dp_target_convert_cnt,  -- è®¢å•è½¬åŒ–æ•°
    custom_convert_cost,    -- è®¢å•è½¬åŒ–æˆæœ¬
    play_duration_5s_rank   -- è®¢å•5Så®Œæ’­ç‡
FROM douplus_order_stats
WHERE order_id IN (?, ?, ?)
  AND stat_time = (SELECT MAX(stat_time) FROM douplus_order_stats WHERE order_id = douplus_order_stats.order_id)
```

**æ•°æ®ç¤ºä¾‹**:
| order_id | stat_time | stat_cost | total_play | custom_like |
|----------|-----------|-----------|------------|-------------|
| 1851843077988506 | 2026-01-26 16:05:00 | 100.00 | 48562 | 1210 |
| 1851843076053052 | 2026-01-26 16:05:00 | 99.97 | 47124 | 1189 |

> æ³¨æ„: å³ä½¿ä¸¤ä¸ªè®¢å•æ¨å¹¿åŒä¸€è§†é¢‘,å®ƒä»¬çš„æ•ˆæœæ•°æ®ä¹Ÿæ˜¯ç‹¬ç«‹çš„!

#### 2. douplus_video_stats_agg (è§†é¢‘é¢„èšåˆè¡¨)

**ç”¨é€”**: è§†é¢‘æ’è¡Œæ¦œ,è´¦å·ç»Ÿè®¡,è§†é¢‘ç»´åº¦æ±‡æ€»æ•°æ®

**ç»´åº¦**: `item_id` + `stat_time`

**å…¸å‹æŸ¥è¯¢** (è§†é¢‘æ’è¡Œæ¦œ):
```sql
-- æŸ¥è¯¢æŸè´¦å·ä¸‹æ‰€æœ‰è§†é¢‘çš„æ±‡æ€»æ•°æ®
SELECT 
    item_id,
    total_cost,          -- è¯¥è§†é¢‘æ‰€æœ‰è®¢å•çš„æ€»æ¶ˆè€—
    total_play,          -- è¯¥è§†é¢‘æ‰€æœ‰è®¢å•çš„æ€»æ’­æ”¾
    avg_convert_cost,    -- è¯¥è§†é¢‘çš„å¹³å‡è½¬åŒ–æˆæœ¬
    avg_5s_rank          -- è¯¥è§†é¢‘çš„å¹³å‡5Så®Œæ’­ç‡
FROM douplus_video_stats_agg
WHERE account_id = ?
  AND stat_time = (SELECT MAX(stat_time) FROM douplus_video_stats_agg)
ORDER BY total_cost DESC
```

**æ•°æ®ç¤ºä¾‹**:
| item_id | total_cost | total_play | avg_convert_cost |
|---------|-----------|------------|------------------|
| 7578051213799787817 | 51359.15 | 25844158 | 12.39 |

> æ³¨æ„: è¿™æ˜¯è¯¥è§†é¢‘çš„æ‰€æœ‰è®¢å•æ±‡æ€»åçš„æ•°æ®!

### å¸¸è§é”™è¯¯æ¡ˆä¾‹

#### âŒ é”™è¯¯æ¡ˆä¾‹1: è®¢å•åˆ—è¡¨ä½¿ç”¨é¢„èšåˆè¡¨

```python
# é”™è¯¯ä»£ç  (å·²ä¿®å¤)
item_ids = [row[3] for row in results]  # è·å–item_id
stats_sql = text("""
    SELECT item_id, total_cost, total_play
    FROM douplus_video_stats_agg
    WHERE item_id IN :item_ids
""")
# é—®é¢˜: item_idç›¸åŒçš„è®¢å•ä¼šæ˜¾ç¤ºç›¸åŒçš„æ±‡æ€»æ•°æ®
```

**åæœ**: 
- è§†é¢‘ 7578051213799787817 æœ‰3ä¸ªè®¢å• (id=2,3,4)
- å®ƒä»¬éƒ½æ˜¾ç¤º total_play=25844158 (è§†é¢‘æ€»æ’­æ”¾)
- å®é™…åº”è¯¥æ˜¾ç¤º: 48562, 47124, 46893 (å„è®¢å•ç‹¬ç«‹æ’­æ”¾)

#### âœ… æ­£ç¡®åšæ³•: è®¢å•åˆ—è¡¨ä½¿ç”¨è®¢å•æ˜ç»†è¡¨

```python
# æ­£ç¡®ä»£ç 
order_ids = [row[4] for row in results]  # è·å–order_id
stats_sql = text("""
    SELECT order_id, stat_cost, total_play
    FROM douplus_order_stats
    WHERE order_id IN :order_ids
      AND stat_time = (SELECT MAX(stat_time) ...)
""")
# æ¯ä¸ªè®¢å•è¿”å›å…¶ç‹¬ç«‹çš„æ•ˆæœæ•°æ®
```

### æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **è®¢å•åˆ—è¡¨**: ä½¿ç”¨ `order_id IN (...)` æ‰¹é‡æŸ¥è¯¢,é¿å…N+1é—®é¢˜
2. **è§†é¢‘æ’è¡Œ**: ä½¿ç”¨é¢„èšåˆè¡¨,é¿å…å®æ—¶GROUP BY
3. **æ—¶é—´çª—å£**: æ€»æ˜¯æŸ¥è¯¢æœ€æ–°çš„stat_time,ä½¿ç”¨å­æŸ¥è¯¢æˆ–ç¼“å­˜
4. **ç´¢å¼•ä¼˜åŒ–**: ç¡®ä¿ `(order_id, stat_time)` å’Œ `(item_id, stat_time)` æœ‰å¤åˆç´¢å¼•

---

## å®‰è£…éƒ¨ç½²

### å‰ç½®æ¡ä»¶

- Ubuntu 20.04+
- Python 3.8+
- MySQL 5.7+
- Redis 5.0+

### ä¸€é”®å®‰è£…

```bash
cd /opt/douplus/douplus-sync-python

# 1. å®‰è£…ç¯å¢ƒ(è‡ªåŠ¨å®‰è£…pipã€Redisã€Pythonä¾èµ–)
./setup.sh

# 2. æµ‹è¯•ä»£ç 
python3 test.py

# 3. å¯åŠ¨æœåŠ¡
./manage.sh start
```

### æ‰‹åŠ¨å®‰è£…

#### æ­¥éª¤1: å®‰è£…ç³»ç»Ÿä¾èµ–

```bash
sudo apt update
sudo apt install -y python3-pip python3-venv redis-server
```

#### æ­¥éª¤2: å®‰è£…Pythonä¾èµ–

```bash
cd /opt/douplus/douplus-sync-python
pip3 install -r requirements.txt --break-system-packages
```

#### æ­¥éª¤3: é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env` æ–‡ä»¶,ä¿®æ”¹æ•°æ®åº“å’ŒRedisé…ç½®

#### æ­¥éª¤4: å¯åŠ¨Redis

```bash
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

#### æ­¥éª¤5: æµ‹è¯•è¿æ¥

```bash
python3 test.py
```

åº”è¯¥çœ‹åˆ°:
```
============================================================
DOU+ PythonåŒæ­¥æœåŠ¡ - ä»£ç æµ‹è¯•
============================================================

>>> æµ‹è¯•1: é…ç½®æ¨¡å—...
âœ“ é…ç½®åŠ è½½æˆåŠŸ
  æ•°æ®åº“: 127.0.0.1:3306/douplus
  Redis: 127.0.0.1:6379

>>> æµ‹è¯•2: æ•°æ®åº“æ¨¡å‹...
âœ“ æ¨¡å‹å¯¼å…¥æˆåŠŸ
âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ,æ´»è·ƒè´¦å·æ•°: 1

...

âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!
```

#### æ­¥éª¤6: å¯åŠ¨æœåŠ¡

```bash
./manage.sh start
```

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„åŒæ­¥ä»»åŠ¡

#### 1. åˆ›å»ºä»»åŠ¡æ–‡ä»¶

åœ¨ `app/tasks/` ç›®å½•åˆ›å»ºæ–°ä»»åŠ¡,ä¾‹å¦‚ `video_agg.py`:

```python
"""
è§†é¢‘èšåˆä»»åŠ¡
"""
from celery import Task
from loguru import logger
from app.models import get_db, DouplusOrderStats, DouplusVideoStatsAgg
from app.utils.time_window import get_current_window


class VideoAggTask(Task):
    """è§†é¢‘èšåˆä»»åŠ¡åŸºç±»"""
    
    def aggregate_video_stats(self):
        """èšåˆè§†é¢‘æ•ˆæœæ•°æ®"""
        db = get_db()
        try:
            stat_time = get_current_window()
            
            # æ‰§è¡ŒèšåˆSQL
            # INSERT INTO douplus_video_stats_agg ...
            # SELECT item_id, SUM(...), AVG(...) 
            # FROM douplus_order_stats 
            # WHERE stat_time = ? 
            # GROUP BY item_id
            
            logger.info(f"è§†é¢‘èšåˆå®Œæˆ: stat_time={stat_time}")
            
        finally:
            db.close()


def aggregate_all_videos():
    """èšåˆæ‰€æœ‰è§†é¢‘æ•°æ®"""
    task = VideoAggTask()
    task.aggregate_video_stats()
```

#### 2. æ³¨å†Œä»»åŠ¡åˆ°Celery

åœ¨ `celery_app.py` ä¸­æ³¨å†Œ:

```python
from app.tasks.video_agg import aggregate_all_videos

# æ³¨å†Œä»»åŠ¡
app.task(name='app.tasks.video_agg.aggregate_all_videos')(aggregate_all_videos)

# æ·»åŠ å®šæ—¶ä»»åŠ¡
app.conf.beat_schedule['aggregate-videos'] = {
    'task': 'app.tasks.video_agg.aggregate_all_videos',
    'schedule': crontab(minute='2-59/5'),  # æ¯5åˆ†é’Ÿ,å»¶è¿Ÿ2åˆ†é’Ÿ
}
```

#### 3. é‡å¯æœåŠ¡

```bash
./manage.sh restart
```

### ä¿®æ”¹å®šæ—¶ä»»åŠ¡é¢‘ç‡

ç¼–è¾‘ `celery_app.py` ä¸­çš„ `beat_schedule`:

```python
app.conf.beat_schedule = {
    'sync-orders-incremental': {
        'task': 'app.tasks.order_sync.sync_all_accounts_incremental',
        'schedule': crontab(minute='*/5'),  # æ¯5åˆ†é’Ÿ
        # 'schedule': crontab(minute='*/10'),  # æ”¹ä¸ºæ¯10åˆ†é’Ÿ
    },
}
```

### è°ƒè¯•å•ä¸ªä»»åŠ¡

```python
# åœ¨Pythonäº¤äº’å¼ç¯å¢ƒä¸­
from app.tasks.order_sync import sync_single_account

# åŒæ­¥å•ä¸ªè´¦å·
sync_single_account(account_id=1, sync_mode="incremental")
```

---

## APIæ–‡æ¡£

### æŠ–éŸ³DOU+ API

#### 1. è®¢å•åˆ—è¡¨API

**æ¥å£**: `GET /open_api/v3.0/douplus/order/list/`

**å‚æ•°**:
```json
{
  "aweme_sec_uid": "è´¦å·secUid",
  "page": 1,
  "page_size": 100
}
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "order_id": "è®¢å•ID",
        "aweme_id": "è§†é¢‘ID",
        "status": "DELIVERING",
        "budget": 10000,  // å•ä½:åˆ†
        "aweme_title": "è§†é¢‘æ ‡é¢˜",
        "create_time": "2026-01-26 12:00:00"
      }
    ],
    "page_info": {
      "total_number": 100,
      "page": 1,
      "page_size": 100
    }
  }
}
```

#### 2. æ•ˆæœæŠ¥å‘ŠAPI

**æ¥å£**: `POST /open_api/v3.0/douplus/order/report/`

**å‚æ•°**:
```json
{
  "aweme_sec_uid": "è´¦å·secUid",
  "begin_time": "2026-01-20",
  "end_time": "2026-01-26"
}
```

**å“åº”**:
```json
{
  "code": 0,
  "data": {
    "data": [
      {
        "dimension_data": {
          "order_id": "è®¢å•ID",
          "item_id": "è§†é¢‘ID"
        },
        "metrics_data": {
          "stat_cost": 10000,  // æ¶ˆè€—(åˆ†)
          "total_play": 5000,
          "custom_like": 100,
          "dy_share": 50,
          "play_duration_5s_rank": 0.36,  // 5ç§’å®Œæ’­ç‡
          "dp_target_convert_cnt": 10,
          "custom_convert_cost": 1000  // è½¬åŒ–æˆæœ¬(åˆ†)
        }
      }
    ]
  }
}
```

---

## è¿ç»´ç®¡ç†

### æœåŠ¡ç®¡ç†å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡(Worker + Beat)
./manage.sh start

# åœæ­¢æœåŠ¡
./manage.sh stop

# é‡å¯æœåŠ¡
./manage.sh restart

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./manage.sh status

# æŸ¥çœ‹æ—¥å¿—(å®æ—¶)
./manage.sh logs

# åªå¯åŠ¨Worker
./manage.sh worker

# åªå¯åŠ¨Beat(å®šæ—¶ä»»åŠ¡)
./manage.sh beat
```

### æ—¥å¿—ç®¡ç†

æ—¥å¿—ä½ç½®:
- Workeræ—¥å¿—: `logs/worker.log`
- Beatæ—¥å¿—: `logs/beat.log`

æŸ¥çœ‹æ—¥å¿—:
```bash
# å®æ—¶æ—¥å¿—
tail -f logs/worker.log

# æŸ¥çœ‹é”™è¯¯
grep ERROR logs/worker.log

# æŸ¥çœ‹ä»Šå¤©çš„åŒæ­¥è®°å½•
grep "è®¢å•åŒæ­¥å®Œæˆ" logs/worker.log | grep "$(date +%Y-%m-%d)"
```

### ç›‘æ§æŒ‡æ ‡

#### 1. æŸ¥çœ‹Celeryä»»åŠ¡çŠ¶æ€

```bash
# è¿›å…¥Pythonç¯å¢ƒ
python3

from celery_app import app
i = app.control.inspect()

# æŸ¥çœ‹æ´»è·ƒä»»åŠ¡
i.active()

# æŸ¥çœ‹å·²æ³¨å†Œä»»åŠ¡
i.registered()

# æŸ¥çœ‹ä»»åŠ¡ç»Ÿè®¡
i.stats()
```

#### 2. æŸ¥çœ‹Redisé˜Ÿåˆ—é•¿åº¦

```bash
redis-cli

# æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—
KEYS celery*

# æŸ¥çœ‹ç‰¹å®šé˜Ÿåˆ—é•¿åº¦
LLEN celery
```

#### 3. æ•°æ®åº“ç›‘æ§

```sql
-- æŸ¥çœ‹åŒæ­¥çŠ¶æ€
SELECT 
    account_id,
    COUNT(*) as order_count,
    MAX(last_sync_time) as last_sync
FROM douplus_order
GROUP BY account_id;

-- æŸ¥çœ‹æ•ˆæœæ•°æ®è¦†ç›–ç‡
SELECT 
    COUNT(DISTINCT order_id) as total_orders,
    COUNT(DISTINCT CASE WHEN stat_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR) 
          THEN order_id END) as recent_synced
FROM douplus_order_stats;
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. Workerå¹¶å‘æ•°è°ƒæ•´

ç¼–è¾‘ `manage.sh`,ä¿®æ”¹Workerå¯åŠ¨å‘½ä»¤:

```bash
# å¢åŠ å¹¶å‘æ•°(é»˜è®¤ä¸ºCPUæ ¸å¿ƒæ•°)
celery -A celery_app worker --concurrency=4 --loglevel=info ...
```

#### 2. æ‰¹é‡æ’å…¥ä¼˜åŒ–

åœ¨ `order_sync.py` ä¸­,å¯ä»¥æ”¹ä¸ºæ‰¹é‡æ’å…¥:

```python
# æ”¶é›†æ‰€æœ‰è®¢å•
orders_to_insert = []
for order_data in orders:
    orders_to_insert.append(self._build_order_dict(order_data, account))

# æ‰¹é‡æ’å…¥
db.bulk_insert_mappings(DouplusOrder, orders_to_insert)
db.commit()
```

#### 3. æ•°æ®åº“è¿æ¥æ± 

åœ¨ `app/models.py` ä¸­è°ƒæ•´:

```python
engine = create_engine(
    settings.database_url,
    pool_size=20,        # å¢åŠ è¿æ¥æ± å¤§å°
    max_overflow=40,     # å¢åŠ æœ€å¤§æº¢å‡º
    pool_pre_ping=True,
    pool_recycle=3600
)
```

---

## å¸¸è§é—®é¢˜

### Q1: Workerå¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**: `./manage.sh start` å `./manage.sh status` æ— è¿›ç¨‹

**æ’æŸ¥**:
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
cat logs/worker.log

# æ‰‹åŠ¨å¯åŠ¨æŸ¥çœ‹é”™è¯¯
celery -A celery_app worker --loglevel=debug
```

**å¸¸è§åŸå› **:
1. Redisæœªå¯åŠ¨: `sudo systemctl start redis-server`
2. æ•°æ®åº“è¿æ¥å¤±è´¥: æ£€æŸ¥ `.env` é…ç½®
3. ä¾èµ–ç¼ºå¤±: `pip3 install -r requirements.txt`

### Q2: ä»»åŠ¡ä¸æ‰§è¡Œ

**ç—‡çŠ¶**: Beatåœ¨è¿è¡Œä½†ä»»åŠ¡ä¸è§¦å‘

**æ’æŸ¥**:
```bash
# æ£€æŸ¥Beatæ—¥å¿—
cat logs/beat.log

# æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ³¨å†Œ
python3 -c "from celery_app import app; print(app.tasks.keys())"
```

**è§£å†³**:
```bash
# é‡å¯æœåŠ¡
./manage.sh restart

# æ¸…ç©ºRedisé˜Ÿåˆ—(æ…ç”¨)
redis-cli FLUSHDB
```

### Q3: æ•°æ®åº“è¿æ¥è¿‡å¤š

**ç—‡çŠ¶**: `Too many connections`

**è§£å†³**:
```python
# åœ¨ app/models.py ä¸­å‡å°‘è¿æ¥æ± 
engine = create_engine(
    settings.database_url,
    pool_size=5,         # å‡å°‘
    max_overflow=10,     # å‡å°‘
)
```

### Q4: å†…å­˜å ç”¨è¿‡é«˜

**è§£å†³**:
```bash
# å‡å°‘Workeræ•°é‡
# ç¼–è¾‘ manage.sh,ä¿®æ”¹å¯åŠ¨å‘½ä»¤
celery -A celery_app worker --concurrency=2 ...

# é™åˆ¶æ¯ä¸ªWorkerå¤„ç†çš„ä»»åŠ¡æ•°
celery -A celery_app worker --max-tasks-per-child=100 ...
```

### Q5: Tokenè¿‡æœŸ

**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤º `APIé”™è¯¯: code=40108`

**è§£å†³**:
1. ç”¨æˆ·éœ€è¦é‡æ–°æˆæƒ
2. æ£€æŸ¥ `douyin_account` è¡¨çš„ `expires_in` å­—æ®µ
3. Javaæˆæƒæ¨¡å—ä¼šè‡ªåŠ¨åˆ·æ–°token

---

## é™„å½•

### A. æ—¶é—´çª—å£è¯´æ˜

æ‰€æœ‰æ•ˆæœæ•°æ®æŒ‰**5åˆ†é’Ÿæ—¶é—´çª—å£**å­˜å‚¨:

```
12:07:35 â†’ 12:05:00
12:03:15 â†’ 12:00:00
12:13:59 â†’ 12:10:00
```

å®ç°: `app/utils/time_window.py`

### B. æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ–éŸ³API    â”‚ â”€â”€â”€â†’  â”‚ åŒæ­¥æœåŠ¡    â”‚ â”€â”€â”€â†’  â”‚   MySQL    â”‚
â”‚            â”‚       â”‚ (Python)   â”‚       â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                     â†“
                           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚              â”‚  èšåˆè¡¨     â”‚
                           â”‚              â”‚ (é¢„è®¡ç®—)    â”‚
                           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                     â†“
                           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æŸ¥è¯¢æœåŠ¡    â”‚
                                          â”‚  (Java)    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### C. Celeryé…ç½®å‚è€ƒ

```python
# ä»»åŠ¡è·¯ç”±
task_routes = {
    'app.tasks.order_sync.*': {'queue': 'order_sync'},
    'app.tasks.stats_sync.*': {'queue': 'stats_sync'},
}

# å®šæ—¶ä»»åŠ¡(Crontabæ ¼å¼)
beat_schedule = {
    'task-name': {
        'task': 'app.tasks.module.function',
        'schedule': crontab(minute='*/5'),  # æ¯5åˆ†é’Ÿ
        # 'schedule': crontab(hour='*/2'),  # æ¯2å°æ—¶
        # 'schedule': crontab(day_of_week=1, hour=7, minute=30),  # æ¯å‘¨ä¸€7:30
    }
}
```

---

## æ–‡æ¡£ç»´æŠ¤

- **åˆ›å»ºæ—¶é—´**: 2026-01-26
- **æœ€åæ›´æ–°**: 2026-01-26
- **ç»´æŠ¤äºº**: å¼€å‘å›¢é˜Ÿ
- **ç‰ˆæœ¬**: v1.0

å¦‚æœ‰é—®é¢˜,è¯·æŸ¥çœ‹æ—¥å¿—æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
